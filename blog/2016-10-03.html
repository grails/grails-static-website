<!DOCTYPE html>
<html>
<head>
    <title>How to Use Travis-CI to Build and Deploy Your Plugin</title>
    <meta name="keywords" content="grails,jvm,framework,groovy,gradle,spring-boot,gorm" />
    <meta name="description" content="How to Use Travis-CI to Build and Deploy Your Grails 3 Plugin" />
    <meta name="date" content="October 3, 2016" />
    <meta name="robots" content="all"/>
    <link rel="alternate" type="application/rss+xml" title="RSS" href="https://grails.org/rss.xml" />
    <meta charset='UTF-8' />
    <link rel='icon' href='https://grails.org/images/favicon.ico'/>
    <meta name='twitter:card' content='summary_large_image'/>
    <meta name='twitter:site' content='@grailsframework'/>
    <meta name='twitter:description' content='How to Use Travis-CI to Build and Deploy Your Grails 3 Plugin'/>
    <meta name='twitter:creator' content='@grailsframework'/>
    <meta property='og:image' content='https://grails.org/images/grails.png'/>
    <meta property='og:image:width' content='300'/>
    <meta property='og:image:height' content='300'/>
    <meta property='og:url' content='https://grails.org'/>
    <meta property='og:title' content='How to Use Travis-CI to Build and Deploy Your Plugin'/>
    <meta property='og:description' content='How to Use Travis-CI to Build and Deploy Your Grails 3 Plugin'/>
    <meta property='og:type' content='website'/>

    <meta name='viewport' content='width=device-width, initial-scale=1' />
    <link rel='mask-icon' href='https://grails.org/images/grails-pinned-icon.svg' color='feb672' />
    <link rel='stylesheet' href='https://grails.org/stylesheets/screen.css' />
    <script src='https://grails.org/javascripts/navigation.js'></script>
    
    <link rel='stylesheet' href='https://grails.org/stylesheets/prism.css'/>
    <script src='https://grails.org/javascripts/prism.js'></script>
</head>
<body><header class='mainheader'>
    <div class='content'>
        <a href='https://grails.org/index.html'><img class='grailslogo' src='https://grails.org/images/grails_logo.svg' alt='Grails Logo' /></a>
        <a href='javascript:show(&apos;topmenus&apos;, &apos;showNavigationLink&apos;)' id='showNavigationLink' class='mobile align-center'>Show Navigation</a>
        <div id='topmenus'>
            <nav class='secondarymenu' id='secondarymenu'><ul>
                <li><a href='https://grails.org/blog/index.html'>Blog</a></li>
                <li><a href='https://grails.org/learning.html'>Learning</a></li>
                <li><a href='https://grails.org/community.html'>Community</a></li>
                <li><a href='https://grails.org/search.html'>Search</a></li>
            </ul></nav>
            <nav class='mainmenu' id='mainmenu'><ul>
                <li><a href='https://grails.org/documentation.html'>Documentation</a></li>
                <li><a href='https://grails.org/download.html'>Download</a></li>
                <li><a href='https://plugins.grails.org'>Plugins</a></li>
                <li><a href='https://guides.grails.org/index.html'>Guides</a></li>
                <li><a href='https://grails.org/faq.html'>FAQ</a></li>
                <li><a href='https://grails.org/support.html'>Support</a></li>
            </ul></nav>
        </div>
    </div>
</header>
<article><div class='headerbar chalicesbg'>
  <div class='content'>
    <h1>
      <a href='https://grails.org/blog/index.html'>Grails Blog</a>
    </h1>
  </div>
</div>
<div class='content container'>
  <div class='light padded blogpost'><h1>How to Use Travis-CI to Build and Deploy Your Plugin</h1>
<p><span class="author">By Søren Berg Glasius</span></p>
<p><span class="date">October 3, 2016</span></p>
<p>Tags: <a href="https://grails.org/blog/tag/plugins.html"><span class="hashtag">#plugins</span></a> <a href="https://grails.org/blog/tag/travis.html"><span class="hashtag">#travis</span></a></p>
<h2>Introduction</h2>
<p>When you create a Grails 3 plugin and you want to share it with the world, wouldn't it be great if building and deploying was taken care of by a CI server?</p>
<p>In this blog I will show you how to set up a Grails Plugin project that will be built and deployed on the <a href="https://travis-ci.org/">Travis-CI infrastructure</a>.</p>
<p>Let us start out by setting up the project, so that it can be deployed to Bintray. Then we will add a Travis build to the mix. Finally we will explore how to handle snapshot deployment to <a href="https://oss.jfrog.org/">JFrog's open source repository</a>.</p>
<h2>How Travis-CI Works</h2>
<p>Travis-CI works by monitoring your GitHub repository and whenever it sees changes, it will make a build of your project. The change can be a new commit pushed to GitHub, a new tag pushed to GitHub, or a pull request to your project on GitHub.</p>
<p>If you want a deeper knowledge on how Travis-CI works, please <a href="https://docs.travis-ci.com/">see the documentation</a>.</p>
<h2>Getting Started</h2>
<p>While you might have a plugin already, let us start this example by creating a plugin. The plugin will not have any functionality; it is only here to show the steps.</p>
<pre><code class="language-bash">grails create-plugin -profile plugin demoplugin
cd demoplugin
</code></pre>
<p>To get Travis-CI working the project has to live on GitHub.</p>
<h3>Setting Up a GitHub Repository</h3>
<p>The first step is to enable Git for the local repository, add the project files, and commit it:</p>
<pre><code class="language-bash">git init
git add .
git commit -m &quot;Initial commit&quot;
</code></pre>
<p>Now go to <a href="https://github.com/">GitHub</a> where we create a new repository:</p>
<p><img src="2016-10-03-img01.png" alt="Create a new repository" /></p>
<p><img src="2016-10-03-img02.png" alt="" /></p>
<p><img src="2016-10-03-img03.png" alt="" /></p>
<p>And push the first commit to GitHub:</p>
<pre><code class="language-bash">git remote add origin https://github.com/sbglasius/demoplugin.git
git push -u origin master
</code></pre>
<h3>Publishing Plugin to Bintray</h3>
<p>Before configuring Travis, let us update the configuration to enable publishing the plugin to Bintray and the Grails Plugin Portal.</p>
<p><code>build.gradle</code> already contains the building blocks for this:</p>
<pre><code class="language-groovy">// ...
group &quot;org.grails.plugins&quot;
// ...
apply plugin:&quot;org.grails.grails-plugin&quot;
// ...
grailsPublish {
    // TODO: Provide values here
    user = 'user'
    key = 'key'
    githubSlug = 'foo/bar'
    license {
        name = 'Apache-2.0'
    }
    title = &quot;My Plugin&quot;
    desc = &quot;Full plugin description&quot;
    developers = [johndoe:&quot;John Doe&quot;]
    portalUser = &quot;&quot;
    portalPassword = &quot;&quot;    
}
</code></pre>
<p>As can be seen, some values are not filled in, like credentials and <code>githubSlug</code>. Let us add those values in a way where credentials are not visible in the public GitHub repository.</p>
<p>My code snippet will contain two ways to fetch configuration values:</p>
<pre><code class="language-groovy">grailsPublish {
    user = System.getenv(&quot;BINTRAY_USER&quot;) ?: project.bintrayUser
    key = System.getenv(&quot;BINTRAY_KEY&quot;) ?: project.bintrayKey
    githubSlug = 'https://github.com/sbglasius/demoplugin'
    license {
        name = 'Apache-2.0'
    }
    title = &quot;Demo Plugin&quot;
    desc = &quot;A Demo Plugin, no need to publish&quot;
    developers = [johndoe:&quot;John Doe&quot;]
    portalUser = System.getenv(&quot;GRAILS_PORTAL_USER&quot;) ?: project.grailsPortalUser
    portalPassword = System.getenv(&quot;GRAILS_PORTAL_PASSWORD&quot;) ?: project.grailsPortalPassword
}
</code></pre>
<p>The configuration values are now read from either the running environment (this is where Travis will provide them, more on this later) or they will be taken from the project configuration or Gradle's global configuration (<code>~/.gradle/gradle.properties</code>). That is where I recommend storing these credentials.</p>
<p>The format for <code>~/.gradle/gradle.properties</code> is like this:</p>
<pre><code class="language-properties">bintrayUser=user
bintrayKey=[secret]

grailsPortalUser=user
grailsPortalPassword=[secret]
</code></pre>
<p>With this in place, it is now possible to publish the plugin to Bintray. This can be done like this:</p>
<pre><code class="language-bash">./gradlew bintrayUpload
</code></pre>
<p>Before moving on to Travis, let me push this to GitHub:</p>
<pre><code class="language-bash">git add .
git commit -m &quot;Build script for Gradle&quot;
git push
</code></pre>
<h2>Set Up Travis Command Line</h2>
<p>Before we can use Travis, we need to install the Travis Command line. Travis Command line requires Ruby, and since my machine is a Mac, Ruby is included. For other OSes, please go <a href="https://www.ruby-lang.org/en/">here</a> for more information.</p>
<p>Install Travis</p>
<pre><code class="language-bash">gem install travis
</code></pre>
<h2>Adding Travis to the Project</h2>
<p>The first thing we will do is initialize Travis for the project.</p>
<pre><code class="language-bash">&amp;#36; travis init
Detected repository as sbglasius/demoplugin, is this correct? |yes|
Main programming language used: |Ruby| Groovy
.travis.yml file created!
sbglasius/demoplugin: enabled :)
</code></pre>
<p>Take a look in <code>.travis.yml</code>. You should see one line of code:</p>
<pre><code class="language-yml">language: groovy
</code></pre>
<p>Let us push this change to GitHub:</p>
<pre><code class="language-bash">git add .travis.yml
git commit -m &quot;Added travis config&quot;
git push
</code></pre>
<p>This will result in the first Travis build – a failed build. When Travis tries to run <code>gradle assemble</code> it fails with the following error:</p>
<pre><code class="language-text">FAILURE: Build failed with an exception.
* Where:
Build file '/home/travis/build/sbglasius/demoplugin/build.gradle' line: 50
* What went wrong:
A problem occurred evaluating root project 'demoplugin'.
&gt; Could not find property 'bintrayUser' on root project 'demoplugin'.
* Try:
Run with --stacktrace option to get the stack trace. Run with --info or --debug option to get more log output.
BUILD FAILED
</code></pre>
<p>As we can see from the error, it cannot find the <code>bintrayUser</code> in the properties – since it is not defined yet together with the other credential properties.</p>
<p>Travis has the ability to set environment variables defined in .travis.yml, but we do not want credentials in clear text. Fortunately, Travis support <a href="https://docs.travis-ci.com/user/environment-variables#Defining-Variables-in-.travis.yml">encrypting environment variables</a>. It is important to understand that the variables added here will only work for the GitHub account associated with the project.</p>
<h3>Adding Environment Variables to <code>.travis.yml.</code></h3>
<p>Let us add four variables to the configuration under <code>env.global</code>:</p>
<pre><code class="language-bash">travis encrypt BINTRAY_USER=user --add env.global
travis encrypt BINTRAY_KEY=*** --add env.global
travis encrypt GRAILS_PORTAL_USER=user --add env.global
travis encrypt GRAILS_PORTAL_PASSWORD=[secret] --add env.global
</code></pre>
<p>Now <code>.travis.yml</code> looks like this:</p>
<pre><code class="language-yml"> language: groovy
env:
  global:
  - secure: iU4Y3JVWFteYl6J9MIlKv4H6nT0...
  - secure: xPW7KBPVHe64hMloY30Oa5WowYO...
  - secure: mhCnvHfjPX+wudLOfo6B8MFVGBV...
  - secure: QF0+kEZLjL3ZJe0U/5jKC1dijgm...
</code></pre>
<p>and then commit and push to GitHub.</p>
<p><em>Now the build goes green on Travis</em>, but it is still not publishing the plugin to Bintray. That's up next.</p>
<h2>Publish to Bintray with Travis</h2>
<p>Travis should test <code>master</code> on GitHub every time code is committed. It should build pull-requests but should only release the plugin to Bintray, when Git is tagged with a new version.</p>
<p>The developers of Travis have thought of this and allow us to use a bash script to make more fine-grained logic. The basic script could look like this:</p>
<pre><code class="language-bash">#!/usr/bin/env bash

set -e
./gradlew clean check assemble --stacktrace

EXIT_STATUS=0
echo &quot;Publishing archives for branch &amp;#36;TRAVIS_BRANCH&quot;
if [[ -n &amp;#36;TRAVIS_TAG ]] || [[ &amp;#36;TRAVIS_BRANCH == 'master' &amp;&amp; &amp;#36;TRAVIS_PULL_REQUEST == 'false' ]]; then
  if [[ -n &amp;#36;TRAVIS_TAG ]]; then
    echo &quot;Pushing build to Bintray&quot;
    ./gradlew bintrayUpload notifyPluginPortal || EXIT_STATUS=&amp;#36;?
  fi
fi
exit &amp;#36;EXIT_STATUS
fi
</code></pre>
<p>The script is currently a bit more advanced than it needs to be; that is because more functionality will be added later.</p>
<p>To execute the script on Travis-CI add these few lines to <code>.travis.yml</code>:</p>
<pre><code class="language-yml">before_script:
- rm -rf target
script: ./travis-build.sh
</code></pre>
<p>I prefer them before the <code>env:</code> block. To allow Travis to actually execute the script, it's important that the script execute flag on <code>travis-build.sh</code> is set:</p>
<pre><code class="language-bash">chmod 755 travis-build.sh
</code></pre>
<p>Add, commit, and push this to GitHub like before.</p>
<p>The result will be a successful build, but not a deployment to Bintray. This is of course due to the <code>if</code> statement in the bash script, which checks if a git tag is set. If it is the <code>master</code> branch and if it's not a pull-request.</p>
<h3>Tag and Release</h3>
<p>I now want to make a release of my plugin. To do so, I need to bump the plugin version in <code>build.gradle</code>, commit the change, tag the commit, and push it to GitHub.</p>
<p>Let me start with <code>build.gradle</code></p>
<pre><code class="language-groovy">version &quot;0.2&quot;
</code></pre>
<p>and the commit, tag, and push:</p>
<pre><code class="language-bash">git commit -a -m &quot;Bump revision to 0.2&quot;
git tag &quot;0.2&quot;
git push --tags
</code></pre>
<p>Notice, that I added <code>--tags</code> to the <code>git</code> command to get tags pushed to GitHub.</p>
<p>That's it. The build is automated, and a release can be created on Bintray by using Travis-CI and GitHub tagging.</p>
<h2>Deploy Snapshots to JFrog OSS Artifactory</h2>
<p>To have snapshot published to a public repo for others to use it, we can resort to Jfrog OSS Artifactory <a href="http://oss.jfrog.org/">oss.jfrog.org (OJO)</a>, since Bintray does not support snapshot builds. (This section is inspired by the <a href="http://www.slideshare.net/alvarosanchezmariscal/mastering-grails-3-plugins-greach-2016">blog post by Álvaro Sánchez</a>). Before you can publish to OJO, please read <a href="https://www.jfrog.com/confluence/display/RTF/Deploying+Snapshots+to+oss.jfrog.org">this document</a>.</p>
<h3>Setup Build Scripts</h3>
<p>Let us start with <code>build.gradle</code>:</p>
<pre><code class="language-groovy">buildscript {
   //...
}
plugins {
  id &quot;com.jfrog.artifactory&quot; version &quot;4.4.0&quot;
}

version &quot;0.3-SNAPSHOT&quot;
group &quot;demoplugin&quot;
//...
grailsPublish {
   //...
}
artifactory {
    contextUrl = 'http://oss.jfrog.org'
    publish {
        repository {
            repoKey = 'oss-snapshot-local'
            username = System.getenv(&quot;BINTRAY_USER&quot;) ?: project.bintrayUser
            password = System.getenv(&quot;BINTRAY_KEY&quot;) ?: project.bintrayKey
        }
        defaults {
            publications('maven')
        }
    }
}
</code></pre>
<p>Since OJO and Bintray are tightly coupled, it is the same credentials used.</p>
<p>Updated <code>travis-build.sh</code></p>
<pre><code class="language-bash">#!/usr/bin/env bash

set -e
./gradlew clean check assemble --stacktrace

EXIT_STATUS=0
echo &quot;Publishing archives for branch &amp;#36;TRAVIS_BRANCH&quot;
if [[ -n &amp;#36;TRAVIS_TAG ]] || [[ &amp;#36;TRAVIS_BRANCH == 'master' &amp;&amp; &amp;#36;TRAVIS_PULL_REQUEST == 'false' ]]; then
  if [[ -n &amp;#36;TRAVIS_TAG ]]; then
    echo &quot;Pushing build to Bintray&quot;
    ./gradlew bintrayUpload || EXIT_STATUS=&amp;#36;?
  else
    echo &quot;Publishing snapshot to OJO&quot;
    ./gradlew artifactoryPublish || EXIT_STATUS=&amp;#36;?
  fi
fi
exit &amp;#36;EXIT_STATUS
fi
</code></pre>
<p>Commit and push to GitHub and go watch the build on Travis-CI. Notice, that the build ends with a push to OJO.</p>
<p>That's it. Travis-CI will now publish both snapshot versions and tagged versions to OJO and Bintray.</p>
<p>But wait – there is a bit more.</p>
<h2>Optimizing Travis-CI setup</h2>
<p>Take a look at the log-output from Travis-CI and notice that it downloads Gradle and all of the maven dependencies on each build.</p>
<p>Travis-CI supports caching of these artifacts and a couple of other options.</p>
<p>Add the following to <code>.travis.yml</code> just below the <code>language: groovy</code> block:</p>
<pre><code class="language-yml">sudo: false # run on container-based infrastructure

before_cache:
  - rm -f &amp;#36;HOME/.gradle/caches/modules-2/modules-2.lock
cache:
  directories:
    - &amp;#36;HOME/.gradle/caches/
    - &amp;#36;HOME/.gradle/wrapper/
    - &amp;#36;HOME/.m2/repositories/
</code></pre>
<p>This will reduce downloads and build time on Travis-CI.</p>
<h2>Conclusion</h2>
<p>Travis-CI is a great tool to build and deploy your Grails plugin; it will help you maintain your code when receiving pull requests from the community. Happy CI'ing!</p>
    <h2>You might also like ...</h2>
    <div class='threecolumns'>
      <div class='column'><article class='blogcard' style='background-image: url(https://grails.org/images/2018-09-23.jpg)'>
  <a href='https://grails.org/blog/2018-09-23.html'>
    <h3>September 23, 2018</h3>
    <h2>Security Vulnerability in Asset-Pipeline and ...</h2>
  </a>
</article></div>
      <div class='column'><article class='blogcard' style='background-image: url(https://grails.org/images/2018-04-05.jpg)'>
  <a href='https://grails.org/blog/2018-04-05.html'>
    <h3>April 5, 2018</h3>
    <h2>Introducing the Grails 3 GORM Logical Delete ...</h2>
  </a>
</article></div>
      <div class='column'><article class='blogcard' style='background-image: url(https://grails.org/images/2016-09-12.jpg)'>
  <a href='https://grails.org/blog/2016-09-12.html'>
    <h3>September 12, 2016</h3>
    <h2>How to Migrate from Resources Plugin to Asset...</h2>
  </a>
</article></div>
    </div>
  </div>
</div>&nbsp;</article>
<footer>
    <div class='content'>
        <div class='ocihometograils'>
            <span>Sponsored by</span>
            <a href='https://objectcomputing.com/products/grails/'><img class='' src='https://grails.org/images/oci_home_to_grails.svg' alt='Object Computing - Home to Grails' width='300px' /></a>
        </div>
        <nav class='socialmedianav'><ul>
            <li>
                <a href='https://grails-slack.cfapps.io'><img class='' src='https://grails.org/images/slack.svg' alt='Slack Icon' /></a>
            </li>
            <li>
                <a href='https://www.youtube.com/watch?v=XnRNfDGkBVg&amp;list=PLI74De5M9T73uH3WilDCePP2qfSDpMaGu'><img class='' src='https://grails.org/images/youtube.svg' alt='Youtube Icon' /></a>
            </li>
            <li>
                <a href='https://www.linkedin.com/groups/39757'><img class='' src='https://grails.org/images/linkedin.svg' alt='LinkedIn Icon' /></a>
            </li>
            <li>
                <a href='https://github.com/grails/'><img class='' src='https://grails.org/images/github.svg' alt='Github Icon' /></a>
            </li>
            <li>
                <a href='https://twitter.com/grailsframework'><img class='' src='https://grails.org/images/twitter.svg' alt='Twitter Icon' /></a>
            </li>
        </ul></nav>
        <nav class='partnersnav'><ul>
            <li>Grails' repositories are hosted by
                <a href='http://artifactoryonline.com/'>Artifactory</a>
            </li>
            <li>Website hosting provided by
                <a href="https://run.pivotal.io/">Pivotal</a>
            </li>
            <li>JetBrains supports Grails with its
                <a href='https://www.jetbrains.com/idea/'>IntelliJ IDEA IDE</a>
            </li>
            <li>YourKit supports Grails with its
                <a href='https://www.yourkit.com/java/profiler/index.jsp'>Java Profiler</a>
            </li>
            <li>Grails is Open Source
                <a href="https://www.apache.org/licenses/LICENSE-2.0.html">Apache 2 License</a>
            </li>
            <li>
                <a href='https://grails.org/buildstatus.html'>Build Status</a>
            </li>
        </ul></nav>
    </div>
</footer><div>
    <script type='text/javascript'>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-82213539-2', 'auto');
        ga('send', 'pageview');
    </script>
    <script type='text/javascript'>
        adroll_adv_id = "HBWJH4CQCJGS5DJRSB4Z4D";
        adroll_pix_id = "IVEQYFOZXZAPZMDVQH7BFE";
        /* OPTIONAL: provide email to improve user identification */
        /* adroll_email = "username@example.com"; */
        (function () {
            var _onload = function(){
                if (document.readyState && !/loaded|complete/.test(document.readyState)){setTimeout(_onload, 10);return}
                if (!window.__adroll_loaded){__adroll_loaded=true;setTimeout(_onload, 50);return}
                var scr = document.createElement("script");
                var host = (("https:" == document.location.protocol) ? "https://s.adroll.com" : "http://a.adroll.com");
                scr.setAttribute('async', 'true');
                scr.type = "text/javascript";
                scr.src = host + "/j/roundtrip.js";
                ((document.getElementsByTagName('head') || [null])[0] ||
                    document.getElementsByTagName('script')[0].parentNode).appendChild(scr);
            };
            if (window.addEventListener) {window.addEventListener('load', _onload, false);}
            else {window.attachEvent('onload', _onload)}
        }());
    </script>
</div>
</body>
</html>