<!DOCTYPE html>
<html>
<head>
    <title>Grails® Mock Logging</title>
    <meta name="keywords" content="grails,jvm,framework,groovy,gradle,spring-boot,gorm" />
    <meta name="description" content="Learn how to test and mock logging in a Grails® Application." />
    <meta name="date" content="May 24, 2018" />
    <meta name="robots" content="all"/>
    <link rel="alternate" type="application/rss+xml" title="RSS" href="https://grails.org/rss.xml" />
    <meta charset='UTF-8' />
    <link rel='icon' href='https://grails.org/images/favicon.ico'/>
    <meta name='twitter:card' content='summary_large_image'/>
    <meta name='twitter:site' content='@grailsframework'/>
    <meta name='twitter:description' content='Learn how to test and mock logging in a Grails® Application.'/>
    <meta name='twitter:creator' content='@grailsframework'/>
    <meta property='og:image' content='https://grails.org/images/grails.png'/>
    <meta property='og:image:width' content='300'/>
    <meta property='og:image:height' content='300'/>
    <meta property='og:url' content='https://grails.org'/>
    <meta property='og:title' content='Grails® Mock Logging'/>
    <meta property='og:description' content='Learn how to test and mock logging in a Grails® Application.'/>
    <meta property='og:type' content='website'/>

    <meta name='viewport' content='width=device-width, initial-scale=1' />
    <link rel='mask-icon' href='https://grails.org/images/grails-pinned-icon.svg' color='feb672' />
    <link rel='stylesheet' href='https://grails.org/stylesheets/screen.css' />
    <script src='https://grails.org/javascripts/navigation.js'></script>
    
    <link rel='stylesheet' href='https://grails.org/stylesheets/prism.css'/>
    <script src='https://grails.org/javascripts/prism.js'></script>
</head>
<body><header class='mainheader'>
    <div class='content'>
        <a href='https://grails.org/index.html'><img class='grailslogo' src='https://grails.org/images/grails_logo.svg' alt='Grails Logo' /></a>
        <a href='javascript:show(&apos;topmenus&apos;, &apos;showNavigationLink&apos;)' id='showNavigationLink' class='mobile align-center'>Show Navigation</a>
        <div id='topmenus'>
            <nav class='secondarymenu' id='secondarymenu'><ul>
                <li><a href='https://grails.org/blog/index.html'>Blog</a></li>
                <li><a href='https://grails.org/learning.html'>Learning</a></li>
                <li><a href='https://grails.org/community.html'>Community</a></li>
                <li><a href='https://grails.org/search.html'>Search</a></li>
            </ul></nav>
            <nav class='mainmenu' id='mainmenu'><ul>
                <li><a href='https://grails.org/documentation.html'>Documentation</a></li>
                <li><a href='https://grails.org/download.html'>Download</a></li>
                <li><a href='https://plugins.grails.org'>Plugins</a></li>
                <li><a href='https://guides.grails.org/index.html'>Guides</a></li>
                <li><a href='https://grails.org/foundation/index.html'>Foundation</a></li>
                <li><a href='https://grails.org/faq.html'>FAQ</a></li>
                <li><a href='https://grails.org/support.html'>Support</a></li>
            </ul></nav>
        </div>
    </div>
</header>
<article><div class='headerbar chalicesbg'>
  <div class='content'>
    <h1>
      <a href='https://grails.org/blog/index.html'>Grails Blog</a>
    </h1>
  </div>
</div>
<div class='content container'>
  <div class='light padded blogpost'><h1>Grails® Mock Logging</h1>
<p><span class="author">By Nirav Assar</span></p>
<p><span class="date">May 24, 2018</span></p>
<p>In Grails<sup>®</sup> 3 applications, logging is handled by the <a href="https://docs.grails.org/latest/guide/conf.html#logging">Logback logging framework</a>. Grails artifacts are configured with logging out of the box. The developer simply invokes <code>log.info(&quot;log whatever&quot;)</code> and it works. But how do we create unit tests that assert that logs occur with the appropriate level?</p>
<p>This blog will highlight some mock logging techniques and when to use them.</p>
<h2>Default Grails Logging in Unit Tests</h2>
<p>First let's get the obvious out of the way for clarity. If you are not concerned about testing how logs operate in your application, there is no reason to worry about mocking loggers in Grails apps.</p>
<p>Since the logger is already present in Grails controllers, services, and domain objects there is no need to mock the logger when running unit tests. When a unit test is run with <a href="https://testing.grails.org/latest/guide/index.html">Grails Testing Support</a>, the logger will execute just as in does in production mode. In this scenario, we can say the logger as already &quot;mocked&quot; for the purpose of focusing on the <a href="https://wiki.c2.com/?ClassUnderTest">Class Under Test</a>. This is distinct from the scenario of actually verifying logging occurs, which we will dive into next.</p>
<h2>Verify Logging with Tests</h2>
<p>What if we want to assert that a certain log occurs with a particular log level? For example, let's say we want to test that that the method below prints friendly advice based on the <code>age</code> parameter.</p>
<pre><code class="language-groovy">package mock.logging

class AgeService {

    void offerAgeAdvice(int age) {

        if (age &lt; 0) {
            log.error (&quot;You cannot be $age years old!&quot;)
        } else if (age in 0..&lt;30) {
            log.info (&quot;You are a young and vibrant :) Age $age&quot;)
            log.info (&quot;Live life to the fullest&quot;)
        } else if (30 &lt;= age) {
            log.warn (&quot;It's all downhill from here, sorry. Age $age&quot;)
        }

    }
}
</code></pre>
<p>In this scenario we need to mock the logger and capture the message passed in. Then we can assert that the message is correct and also assert the appropriate log level was used in each scenario. Conceptually, this is pretty easy. But in practice not so much.</p>
<h2>Why Not Use Spock?</h2>
<p>One would think that we should simply mock out the logger with <code>def mockLogger = Mock(Logger)</code>, then set the service in the unit test with <code>service.log = mockLogger</code>. We could proceed to check the arguments passed in and also the number of times <code>service.log</code> is called with spock programming. However, in Grails apps we run into a few basic problems while trying to mock with native spock or even <a href="https://groovy-lang.org/testing.html#_mockfor_and_stubfor">Groovy MockFor</a>.</p>
<p>Logback is the default framework and the <a href="https://logback.qos.ch/apidocs/ch/qos/logback/classic/Logger.html">Logger</a> is <code>final</code>. We cannot mock a final class. Furthermore, the injected <code>log</code>property in Grails artifacts is a read-only property and cannot be set. These two fundamental problems prohibit spock mocks from being effective in most mock logging situations in Grails apps.</p>
<h2>Use Mockito to Verify Log Events</h2>
<p>The <a href="https://site.mockito.org/">Mockito</a> Library can be used to verify logs take place. With Mockito, we can create a mock <code>Appender</code> class, attach it to the logger, and then use an <code>ArgumentCaptor</code> to capture the invocations sent to the logger.</p>
<p>build.gradle</p>
<pre><code class="language-groovy">dependencies { 
    ...
    testCompile &quot;org.mockito:mockito-core:2.+&quot;
}
</code></pre>
<p>Spock test with Mockito</p>
<pre><code class="language-groovy">    void &quot;verify logging with mockito appender&quot;() {
        when: &quot;we attach a mocked appender to the logger&quot;
        Appender mockedAppender = Mockito.mock(Appender)
        Logger logger = LoggerFactory.getLogger(&quot;mock.logging.AgeService&quot;)
        logger.addAppender(mockedAppender)

        service.offerAgeAdvice(22)

        ArgumentCaptor&lt;Appender&gt; argumentCaptor = ArgumentCaptor.forClass(Appender)
        Mockito.verify(mockedAppender,
                       Mockito.times(2)).doAppend(argumentCaptor.capture())
        logger.detachAppender(mockedAppender)

        then: &quot;we capture the arguments and verify log statements occurred&quot;
        argumentCaptor.getAllValues().size() == 2
        List&lt;LoggingEvent&gt; loggingEvents = argumentCaptor.getAllValues()
        loggingEvents[0].getMessage() == &quot;You are a young and vibrant :) Age 22&quot;
        loggingEvents[0].getLevel() == Level.INFO
        loggingEvents[1].getMessage() == &quot;Live life to the fullest&quot;
        loggingEvents[1].getLevel() == Level.INFO
    }
</code></pre>
<h2>Use Slf4j Test to Verify Log Events</h2>
<p><a href="https://projects.lidalia.org.uk/slf4j-test/">Slf4j Test</a> is a test implementation of Slf4j that stores log messages in memory and provides messages for retrieving them. This works nicely to substitute for the real implementation in the test environment of Grails apps.</p>
<p>In <code>build.gradle</code>, we first need to depend on the jar, and then exclude the real implementation from the test environment. It is quite simple to check the logging events.</p>
<p>build.gradle</p>
<pre><code class="language-groovy">dependencies { 
    ...
    testCompile 'uk.org.lidalia:slf4j-test:1.1.0'
}

configurations {
    testCompile.exclude group: 'ch.qos.logback', module: 'logback-classic'
}
</code></pre>
<p>Spock test with Slf4j Test</p>
<pre><code class="language-groovy">    void &quot;verify logging with slf4j-test&quot;() {
        when:
        TestLogger logger = TestLoggerFactory.getTestLogger(&quot;logging.AgeService&quot;)

        service.offerAgeAdvice(-1)

        ImmutableList&lt;LoggingEvent&gt; loggingEvents = logger.getLoggingEvents()

        then:
        loggingEvents.size() == 1
        loggingEvents[0].message == &quot;You cannot be -1 years old!&quot;
        loggingEvents[0].level == uk.org.lidalia.slf4jext.Level.ERROR
    }
</code></pre>
<h2>Use Spock Mocks With a Declared Logger</h2>
<p>Spock mocks can be used on one particular case: with your own declared logger variable. If defined as non-final, you can use spock mocks to verify log calls. This approach is straightforward, but has the drawback that each class will have repeated code and does not rely on Grails conventions.</p>
<p>For example, use a <code>LoggerFactory</code> to define a logger in a class.</p>
<pre><code class="language-groovy">package mock.logging

import org.slf4j.Logger
import org.slf4j.LoggerFactory

/**
 * Non grails groovy class with a declared Slf4j logging object
 */
class DeclaredSlf4jService {

    private static Logger log = LoggerFactory.getLogger(DeclaredSlf4jService)

    void logSomething() {
        println &quot;*********** log in the class ******&quot; + log.dump()
        log.info(&quot;Live life to the fullest&quot;)
    }
</code></pre>
<p>Then a spock Specification with <code>Mock()</code> follows the normal spock conventions to verify invocations and parameters.</p>
<pre><code class="language-groovy">package mock.logging

import org.slf4j.Logger
import spock.lang.Specification

class DeclaredSlf4jServiceSpec extends Specification {

    DeclaredSlf4jService declaredSlf4jService = new DeclaredSlf4jService()
    def mockLogger = Mock(Logger)

    def setup() {
        declaredSlf4jService.log = mockLogger
    }

    def cleanup() {
    }

    void &quot;test mock with spock on declared logger&quot;() {
        when:
        declaredSlf4jService.logSomething()

        then:
        1 * mockLogger.info(&quot;Live life to the fullest&quot;)
    }
}
</code></pre>
<h2>Sample Code</h2>
<p>Sample code of Grails mocking logging can be found here. I hope these examples can help you decide on the best approach for your project.</p>
<ul>
<li><a href="https://github.com/niravassar/mock-logging-slf4j-test">https://github.com/niravassar/mock-logging-slf4j-test</a></li>
<li><a href="https://github.com/niravassar/mock-logging">https://github.com/niravassar/mock-logging</a></li>
</ul>
    <h2 class='space-above'>
      <span>You might also like ...</span>
    </h2>
    <div class='threecolumns'>
      <div class='column'><article class='blogcard' style='background-image: url(https://grails.org/images/2019-12-20.jpg)'>
  <a href='https://grails.org/blog/2021-11-11.html'>
    <h3>November 11, 2021</h3>
    <h2>Grails® 5 - Groovy Podcast Episode 84</h2>
  </a>
</article></div>
      <div class='column'><article class='blogcard' style='background-image: url(https://grails.org/images/grails-blog-index-3.png)'>
  <a href='https://grails.org/blog/2021-10-11-grails-5-ga.html'>
    <h3>October 11, 2021</h3>
    <h2>Grails framework 5 GA Released</h2>
  </a>
</article></div>
      <div class='column'><article class='blogcard' style='background-image: url(https://grails.org/images/grails-blog-index-1.png)'>
  <a href='https://grails.org/blog/2021-10-08-developer-advocate-announced.html'>
    <h3>October 8, 2021</h3>
    <h2>New Developer Advocate Announced</h2>
  </a>
</article></div>
    </div>
  </div>
</div>&nbsp;</article>
<footer>
    <div class='content'>
        <div class='ocihometograils'>
            <span style="margin-bottom:12px;">Sponsored by</span>
            <a href='https://objectcomputing.com/products/grails/'><img class='' src='https://grails.org/images/oci-logo.svg' alt='Object Computing is proud to be home to the Grails framework' width='300px' /></a>
            <span style="margin-top:22px;">&copy; 2021 Grails Foundation. All rights reserved.</span>
        </div>
        <nav class='socialmedianav'><ul>
            <li>
                <a href='https://slack.grails.org'><img class='' src='https://grails.org/images/slack.svg' alt='Slack Icon' /></a>
            </li>
            <li>
                <a href='https://www.youtube.com/watch?v=XnRNfDGkBVg&amp;list=PLI74De5M9T73uH3WilDCePP2qfSDpMaGu'><img class='' src='https://grails.org/images/youtube.svg' alt='Youtube Icon' /></a>
            </li>
            <li>
                <a href='https://www.linkedin.com/groups/39757'><img class='' src='https://grails.org/images/linkedin.svg' alt='LinkedIn Icon' /></a>
            </li>
            <li>
                <a href='https://github.com/grails/'><img class='' src='https://grails.org/images/github.svg' alt='Github Icon' /></a>
            </li>
            <li>
                <a href='https://twitter.com/grailsframework'><img class='' src='https://grails.org/images/twitter.svg' alt='Twitter Icon' /></a>
            </li>
        </ul></nav>
        <nav class='partnersnav'><ul>
            <li>Repositories are hosted by
                <a href='https://grails.jfrog.io/'>Artifactory</a>
            </li>
            <li>Website hosting provided by
                <a href="https://aws.amazon.com/">AWS</a>
            </li>
            <li>JetBrains supports the Grails framework with its
                <a href='https://www.jetbrains.com/idea/'>IntelliJ IDEA IDE</a>
            </li>
            <li>YourKit supports the Grails framework with its
                <a href='https://www.yourkit.com/java/profiler/'>Java Profiler</a>
            </li>
            <li>The Grails framework is Open Source
                <a href="https://www.apache.org/licenses/LICENSE-2.0.html">Apache 2 License</a>
            </li>
             <li>
                <a href='https://cve.mitre.org/cgi-bin/cvekey.cgi?keyword=grails'>Security/Vulnerability Information</a>
            </li>
            <li>
                <a href='https://grails.org/buildstatus.html'>Build Status</a>
            </li>
            <li>
                <a href='https://grails.org/privacy-policy.html'>Privacy Policy</a>
            </li>
        </ul></nav>
    </div>
</footer><div>
    <script type='text/javascript'>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-82213539-2', 'auto');
        ga('send', 'pageview');
    </script>
    <script type='text/javascript'>
        adroll_adv_id = "HBWJH4CQCJGS5DJRSB4Z4D";
        adroll_pix_id = "IVEQYFOZXZAPZMDVQH7BFE";
        /* OPTIONAL: provide email to improve user identification */
        /* adroll_email = "username@example.com"; */
        (function () {
            var _onload = function(){
                if (document.readyState && !/loaded|complete/.test(document.readyState)){setTimeout(_onload, 10);return}
                if (!window.__adroll_loaded){__adroll_loaded=true;setTimeout(_onload, 50);return}
                var scr = document.createElement("script");
                var host = (("https:" == document.location.protocol) ? "https://s.adroll.com" : "https://a.adroll.com");
                scr.setAttribute('async', 'true');
                scr.type = "text/javascript";
                scr.src = host + "/j/roundtrip.js";
                ((document.getElementsByTagName('head') || [null])[0] ||
                    document.getElementsByTagName('script')[0].parentNode).appendChild(scr);
            };
            if (window.addEventListener) {window.addEventListener('load', _onload, false);}
            else {window.attachEvent('onload', _onload)}
        }());
    </script>
</div>
</body>
</html>
